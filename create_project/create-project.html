<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cr√©er un projet ‚Äî SkillBridge</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="create-project.css">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
        <a href="/index.html" class="logo-link">
      <h1>Skill<span>Bridge</span></h1>
    </a>
    <ul>
      <li><a href="/home/home.html">Accueil</a></li>
      <li><a href="/projects/projects.html">Projets</a></li>
      <li><a href="/profile/profile.html">Profil</a></li>
    </ul>
  </nav>

  <!-- Formulaire -->
  <section class="form-section">
    <div class="form-container">
      <h1>Cr√©er un nouveau projet üöÄ</h1>
      <p class="subtitle">D√©cris ton id√©e et invite d‚Äôautres √©tudiants √† collaborer avec toi.</p>

      <form id="createProjectForm">
        <div class="form-group">
          <label for="title">Nom du projet</label>
          <input type="text" id="title" name="title" placeholder="Ex : Plateforme de tutorat √©tudiant" required>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" rows="5" placeholder="D√©cris ton projet en quelques lignes..." required></textarea>
        </div>

        <div class="form-group">
          <label for="category">Cat√©gorie</label>
          <select id="category" name="category" required>
            <option value="">-- Choisir une cat√©gorie --</option>
            <option value="D√©veloppement web">D√©veloppement web</option>
            <option value="IA & Data Science">IA & Data Science</option>
            <option value="Design & UI/UX">Design & UI/UX</option>
            <option value="Jeux vid√©o">Jeux vid√©o</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div class="form-group">
          <label for="members">Membres recherch√©s</label>
          <input type="text" id="members" name="members" placeholder="Ex : 1 designer, 2 d√©veloppeurs back-end">
        </div>

        <div class="form-actions">
          <button type="submit" class="publish-btn">Publier le projet</button>
          <button type="button" class="cancel-btn" onclick="window.history.back()">Annuler</button>
        </div>
      </form>
    </div>
  </section>

  <script>
    (function(){
      const API_BASE = 'http://localhost:4001';
      const form = document.getElementById('createProjectForm');
      const submitBtn = form.querySelector('.publish-btn');

      // require login: get current user from localStorage
      const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
      if (!currentUser) {
        // redirect to login if not authenticated
        window.location.href = '/login/login.html';
        return;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.textContent = 'Publication...';

        const title = document.getElementById('title').value.trim();
        const description = document.getElementById('description').value.trim();
        const category = document.getElementById('category').value;
        const membersInput = document.getElementById('members').value.trim();

        // Normalize members: allow CSV or JSON array or single identifier
        let members = membersInput;
        if (!membersInput) members = [];
        else {
          try {
            const parsed = JSON.parse(membersInput);
            if (Array.isArray(parsed)) members = parsed;
          } catch (err) {
            if (membersInput.includes(',')) members = membersInput.split(',').map(s => s.trim()).filter(Boolean);
          }
        }

        // Prefer sending an owner identifier that backend can resolve: use email when available
        const ownerIdentifier = currentUser.email || currentUser.id || currentUser.numeroEtudiant || currentUser._id;

        // Basic client-side validation
        if (!title || !description || !category) {
          alert('Veuillez renseigner le titre, la description et la cat√©gorie.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Publier le projet';
          return;
        }

        const body = {
          title,
          description,
          category,
          members,
          owner: ownerIdentifier
        };

        try {
          const res = await fetch(`${API_BASE}/api/projects/createProject`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = data.message || data.error || res.status;
            alert('Erreur lors de la cr√©ation du projet: ' + msg);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Publier le projet';
            return;
          }

          // backend returns populated project with _id
          const projectId = data._id || (data.project && data.project._id);
          alert('üéâ Projet cr√©√© avec succ√®s !');
          if (projectId) {
            window.location.href = `/projet_details/project-details.html?id=${projectId}`;
          } else {
            window.location.href = '/projects/projects.html';
          }
        } catch (err) {
          console.error('Create project failed', err);
          alert('Impossible de cr√©er le projet pour le moment.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Publier le projet';
        }
      });
    })();
  </script>

</body>
</html>
